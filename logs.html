<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Logs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
        .log-container {
            max-height: 80vh;
            overflow-y: auto;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .log-entry:nth-child(odd) {
            background-color: #f9f9f9;
        }
        .log-time {
            color: #666;
            font-size: 0.8rem;
        }
        .log-user {
            font-weight: bold;
            color: #007bff;
        }
        .log-endpoint {
            color: #28a745;
        }
        .log-method {
            font-weight: bold;
        }
        .log-ip {
            color: #dc3545;
        }
        .filter-container {
            margin-bottom: 15px;
        }
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .error-message {
            color: #dc3545;
            margin-top: 10px;
        }
        .log-status-200 { color: #28a745; }
        .log-status-300 { color: #17a2b8; }
        .log-status-400 { color: #ffc107; }
        .log-status-500 { color: #dc3545; }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="auth-section" class="auth-container">
        <h2 class="mb-4">System Logs Authentication</h2>
        <div class="mb-3">
            <label for="password" class="form-label">Admin Password</label>
            <input type="password" class="form-control" id="password">
        </div>
        <button class="btn btn-primary" id="login-btn">Access Logs</button>
        <div id="error-message" class="error-message hidden"></div>
    </div>

    <!-- Logs Section (Hidden until authenticated) -->
    <div id="logs-section" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>System Logs</h1>
            <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
        </div>

        <div class="filter-container row">
            <div class="col-md-3 mb-2">
                <input type="text" id="user-filter" class="form-control" placeholder="Filter by user">
            </div>
            <div class="col-md-3 mb-2">
                <input type="text" id="endpoint-filter" class="form-control" placeholder="Filter by endpoint">
            </div>
            <div class="col-md-2 mb-2">
                <select id="method-filter" class="form-control">
                    <option value="">All Methods</option>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
            </div>
            <div class="col-md-2 mb-2">
                <select id="status-filter" class="form-control">
                    <option value="">All Status</option>
                    <option value="2">200s</option>
                    <option value="3">300s</option>
                    <option value="4">400s</option>
                    <option value="5">500s</option>
                </select>
            </div>
            <div class="col-md-2 mb-2">
                <button id="clear-filters" class="btn btn-outline-secondary w-100">Clear Filters</button>
            </div>
        </div>

        <div class="log-container" id="log-container">
            <!-- Logs will be loaded here -->
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading logs...</p>
            </div>
        </div>
    </div>

    <script>
        // Hard-coded admin password - in a real application, this would be handled server-side
        // This is a simple client-side implementation for demonstration
        const ADMIN_PASSWORD = "Cremma2023!";
        let logData = [];

        document.addEventListener('DOMContentLoaded', function() {
            const authSection = document.getElementById('auth-section');
            const logsSection = document.getElementById('logs-section');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const errorMessage = document.getElementById('error-message');
            const logContainer = document.getElementById('log-container');
            
            // Filter elements
            const userFilter = document.getElementById('user-filter');
            const endpointFilter = document.getElementById('endpoint-filter');
            const methodFilter = document.getElementById('method-filter');
            const statusFilter = document.getElementById('status-filter');
            const clearFiltersBtn = document.getElementById('clear-filters');

            // Check if already authenticated
            const isAuthenticated = sessionStorage.getItem('logs_authenticated') === 'true';
            if (isAuthenticated) {
                showLogsSection();
                fetchLogs();
            }

            // Login functionality
            loginBtn.addEventListener('click', function() {
                if (passwordInput.value === ADMIN_PASSWORD) {
                    errorMessage.classList.add('hidden');
                    sessionStorage.setItem('logs_authenticated', 'true');
                    showLogsSection();
                    fetchLogs();
                } else {
                    errorMessage.textContent = 'Invalid password. Please try again.';
                    errorMessage.classList.remove('hidden');
                    passwordInput.value = '';
                }
            });

            // Allow Enter key to submit
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginBtn.click();
                }
            });

            // Logout functionality
            logoutBtn.addEventListener('click', function() {
                sessionStorage.removeItem('logs_authenticated');
                showAuthSection();
            });

            // Apply filters
            function applyFilters() {
                const userText = userFilter.value.toLowerCase();
                const endpointText = endpointFilter.value.toLowerCase();
                const methodText = methodFilter.value;
                const statusText = statusFilter.value;
                
                renderLogs(logData.filter(log => {
                    return (!userText || log.user.toLowerCase().includes(userText)) &&
                           (!endpointText || log.endpoint.toLowerCase().includes(endpointText)) &&
                           (!methodText || log.method === methodText) &&
                           (!statusText || String(log.status).startsWith(statusText));
                }));
            }

            // Add filter event listeners
            userFilter.addEventListener('input', applyFilters);
            endpointFilter.addEventListener('input', applyFilters);
            methodFilter.addEventListener('change', applyFilters);
            statusFilter.addEventListener('change', applyFilters);
            
            // Clear filters
            clearFiltersBtn.addEventListener('click', function() {
                userFilter.value = '';
                endpointFilter.value = '';
                methodFilter.value = '';
                statusFilter.value = '';
                renderLogs(logData);
            });

            // Helper functions
            function showLogsSection() {
                authSection.classList.add('hidden');
                logsSection.classList.remove('hidden');
            }

            function showAuthSection() {
                authSection.classList.remove('hidden');
                logsSection.classList.add('hidden');
                passwordInput.value = '';
            }

            // Fetch logs from API
            function fetchLogs() {
                // Add token to request to authenticate with the server
                fetch('/api/logs?token=' + encodeURIComponent(ADMIN_PASSWORD))
                    .then(response => {
                        if (!response.ok) {
                            if (response.status === 401) {
                                // If unauthorized, return to login
                                sessionStorage.removeItem('logs_authenticated');
                                showAuthSection();
                                throw new Error('Session expired. Please login again.');
                            }
                            throw new Error('Failed to fetch logs');
                        }
                        return response.json();
                    })
                    .then(data => {
                        logData = data;
                        renderLogs(data);
                    })
                    .catch(error => {
                        logContainer.innerHTML = `
                            <div class="alert alert-danger m-3">
                                Error loading logs: ${error.message}
                            </div>
                        `;
                    });
            }

            // Render logs to the container
            function renderLogs(logs) {
                if (logs.length === 0) {
                    logContainer.innerHTML = '<div class="p-4 text-center">No logs found matching the criteria.</div>';
                    return;
                }

                logContainer.innerHTML = logs.map(log => {
                    const date = new Date(log.timestamp);
                    const formattedDate = date.toLocaleString();
                    const statusClass = `log-status-${Math.floor(log.status / 100)}00`;
                    
                    return `
                        <div class="log-entry">
                            <div class="log-time">${formattedDate}</div>
                            <div>
                                <span class="log-user">${log.user || 'Anonymous'}</span> 
                                <span class="log-method">${log.method}</span> 
                                <span class="log-endpoint">${log.endpoint}</span>
                                <span class="${statusClass}">Status: ${log.status}</span>
                            </div>
                            <div class="log-ip">IP: ${log.ip}</div>
                            ${log.details ? `<div class="mt-1"><small>${log.details}</small></div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            // Auto-refresh logs every 30 seconds
            setInterval(fetchLogs, 30000);
        });
    </script>
</body>
</html> 