<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CREMMA - Check List</title>
    <link rel="icon" type="image/png" href="img/favicon.png">
    <script src="js/loadHeader.js"></script>
    <script src="js/sidebar-toggle.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/orientation.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    <style>
        /* Make the open checklist filter switch larger */
        #openChecklistFilter {
            width: 3em;
            height: 1.5em;
            cursor: pointer;
        }
        label[for="openChecklistFilter"] {
            cursor: pointer;
            padding-left: 0.5rem;
            font-size: 1rem;
            font-weight: bold;
            padding-top: 0.3rem;
        }

        .table .form-check-input {
            width: 1.5em;
            height: 1.5em;
        }

        /* Set a minimum width for the responsible group filter */
        #responsibleGroupFilter-ts-control {
            min-width: 200px; /* Adjust as needed */
        }


        #frequencyFilter-ts-control {
            min-width: 150px; /* Adjust as needed */
        }

        /* Sticky Header Styles */
        header {
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        header.scrolled {
            padding: 0.5rem 1rem !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        header.scrolled h5 {
            font-size: 1.1rem;
            transition: font-size 0.3s ease;
        }

        header.scrolled .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        header.scrolled .btn i {
            font-size: 0.875rem;
        }

        header .btn {
            transition: all 0.3s ease;
        }

        header h5 {
            transition: font-size 0.3s ease;
        }
    </style>
</head>

<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar">
            <div id="logo-container"></div>
            <div id="sidebar-nav"></div>
            <div id="sidebar-user"></div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="d-flex justify-content-between p-3 bg-white">
                <div class="d-flex align-items-center">
                    <button id="sidebarToggle" class="btn btn-link d-md-none">
                        <i class="bi bi-list"></i>
                    </button>
                    <h5 class="mb-0">Check List</h5>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary" onclick="logout()">
                        Çıkış Yap <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
            </header>

            <!-- Content -->
            <div class="container-fluid mt-4">
                <!-- Filters -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-start align-items-center gap-3">
                            <!-- Open Checklists Filter -->
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="openChecklistFilter">
                                <label class="form-check-label" for="openChecklistFilter">Açık Checklistler</label>
                                <span id="openChecklistCount" class="badge bg-secondary ms-1">0</span>
                            </div>

                            <!-- Frequency Filter -->
                            <div>
                                <select id="frequencyFilter" class="form-select form-select-sm" multiple placeholder="Sıklık Seç..."></select>
                            </div>

                            <!-- Responsible Group Filter -->
                            <div>
                                <select id="responsibleGroupFilter" class="form-select form-select-sm" multiple placeholder="Sorumlu Grup Seç..."></select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="mb-0">Check List</h4>
                            <button class="btn btn-danger" id="kaydetBtn">Kaydet</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 5%">Kod</th>
                                        <th style="width: 10%">İş Kodu</th>
                                        <th style="width: 20%">İş Tanımı</th>
                                        <th style="width: 10%; text-align: center;">İşlem</th>
                                        <th style="width: 15%">Açıklama</th>
                                        <th style="width: 15%">Sorumlu Personel</th>
                                        <th style="width: 10%">Sorumlu Grup</th>
                                        <th style="width: 5%">Sıklık</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <script>
        let allChecklistItems = [];
        let frequencySelect, responsibleGroupSelect;

        document.addEventListener('DOMContentLoaded', function () {
            initializeFilters();
            loadCheckList();
            document.getElementById('kaydetBtn').addEventListener('click', saveCheckList);
        });

        function getFrequencyText(freq) {
            switch (String(freq)) {
                case '1': return 'Günlük';
                case '2': return 'Haftalık';
                case '3': return 'Aylık';
                default: return 'Bilinmiyor';
            }
        }

        function initializeFilters() {
            frequencySelect = new TomSelect('#frequencyFilter', { create: false, plugins: ['remove_button'] });
            responsibleGroupSelect = new TomSelect('#responsibleGroupFilter', { create: false, plugins: ['remove_button'] });

            document.getElementById('openChecklistFilter').addEventListener('change', filterAndDisplayItems);
            frequencySelect.on('change', filterAndDisplayItems);
            responsibleGroupSelect.on('change', filterAndDisplayItems);
        }

        async function loadCheckList() {
            try {
                const sessionId = localStorage.getItem('sessionId');
                const whsCode = localStorage.getItem("branchCode");

                if (!sessionId || !whsCode) {
                    Swal.fire({ icon: 'error', title: 'Hata', text: 'Oturum bilgisi bulunamadı. Lütfen tekrar giriş yapın.' });
                    return;
                }

                const response = await fetch(`/api/checklist?sessionId=${sessionId}&whsCode=${whsCode}`, { cache: 'no-cache' });
                const data = await response.json();

                if (data.success) {
                    allChecklistItems = data.data.map(item => ({
                        ...item,
                        FrequencyText: getFrequencyText(item.Frequency)
                    }));
                    populateFilterOptions();
                    filterAndDisplayItems();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error loading checklist:', error);
                Swal.fire({ icon: 'error', title: 'Hata', text: 'Kontrol listesi yüklenirken bir hata oluştu.' });
            }
        }

        function populateFilterOptions() {
            const frequencies = [...new Set(allChecklistItems.map(item => item.FrequencyText))].map(f => ({ value: f, text: f }));
            const groups = [...new Set(allChecklistItems.map(item => item.SorumluGrup).filter(g => g))].map(g => ({ value: g, text: g }));

            frequencySelect.clearOptions();
            frequencySelect.addOptions(frequencies);

            responsibleGroupSelect.clearOptions();
            responsibleGroupSelect.addOptions(groups);
        }

        function filterAndDisplayItems() {
            const isOpenOnly = document.getElementById('openChecklistFilter').checked;
            const selectedFrequencies = frequencySelect.getValue();
            const selectedGroups = responsibleGroupSelect.getValue();

            let filteredItems = allChecklistItems;

            // Apply text/select filters first
            if (selectedFrequencies.length > 0) {
                filteredItems = filteredItems.filter(item => selectedFrequencies.includes(item.FrequencyText));
            }

            if (selectedGroups.length > 0) {
                filteredItems = filteredItems.filter(item => selectedGroups.includes(item.SorumluGrup));
            }

            // After filtering, count the open ones and update the badge
            const openCount = filteredItems.filter(item => !item.DocDate).length;
            document.getElementById('openChecklistCount').textContent = openCount;

            // Now, apply the 'open only' filter if it's checked
            if (isOpenOnly) {
                filteredItems = filteredItems.filter(item => !item.DocDate);
            }

            renderTable(filteredItems);
        }

        function renderTable(items) {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';

            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Filtreyle eşleşen kayıt bulunamadı.</td></tr>';
                return;
            }

            items.forEach(item => {
                const row = document.createElement('tr');
                const isDone = item.DocDate; // DocDate being present means it's done

                row.innerHTML = `
                    <td class="align-middle">${item.RowCnt}</td>
                    <td class="align-middle">${item.WorkCode}</td>
                    <td class="align-middle">${item.WorkName}</td>
                    <td class="align-middle text-center">
                        <div class="form-check d-flex justify-content-center">
                            <input class="form-check-input" type="checkbox" ${isDone ? 'checked disabled' : ''}>
                        </div>
                    </td>
                    <td class="align-middle">${item.FreeText || ''}</td>
                    <td class="align-middle">${item.Responsible || ''}</td>
                    <td class="align-middle">${item.SorumluGrup || ''}</td>
                    <td class="align-middle">${item.FrequencyText || ''}</td>
                `;
                row.dataset.workCode = item.WorkCode;
                tbody.appendChild(row);
            });
        }

        async function saveCheckList() {
            try {
                const sessionId = localStorage.getItem('sessionId');
                const whsCode = localStorage.getItem("branchCode");
                const localStorageUserName = localStorage.getItem("userName");

                if (!sessionId || !whsCode) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Hata',
                        text: 'Oturum bilgisi bulunamadı. Lütfen tekrar giriş yapın.'
                    });
                    return;
                }

                // Get only checked AND not disabled checkboxes
                const checkboxes = document.querySelectorAll('.form-check-input:checked:not([disabled])');
                const tasks = Array.from(checkboxes).map(checkbox => {
                    const row = checkbox.closest('tr');
                    // Find the original item from allChecklistItems to get original data
                    const originalItem = allChecklistItems.find(item => item.WorkCode == row.dataset.workCode);
                    return {
                        LineNum: originalItem.RowCnt,
                        TaskCode: originalItem.WorkCode,
                        TaskName: originalItem.WorkName,
                        Status: 'C',  // Completed
                        Description: originalItem.FreeText,
                        Frequency: originalItem.Frequency, // Send original numeric value
                    };
                });

                if (tasks.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Uyarı',
                        text: 'Lütfen en az bir işlem seçin.'
                    });
                    return;
                }

                console.log('Tasks to be sent:', tasks);
                const response = await fetch(`/api/checklist/update?sessionId=` + sessionId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        whsCode,
                        localStorageUserName,
                        tasks
                    })
                });

                console.log('Response:', response);
                const data = await response.json();
                console.log('Response:', data);

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Başarılı',
                        text: 'Değişiklikler kaydedildi.'
                    });
                    loadCheckList();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error saving checklist:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Hata',
                    text: 'Değişiklikler kaydedilirken bir hata oluştu.'
                });
            }
        }
    </script>
    <script src="js/api.js"></script>
<script>
    // Sticky Header Scroll Effect
    let lastScrollTop = 0;
    const header = document.querySelector('header');
    
    window.addEventListener('scroll', function() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        if (scrollTop > 50) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
        
        lastScrollTop = scrollTop;
    }, false);
</script>
</body>

</html>